#!/bin/bash
set -euo pipefail

# Farben direkt am Anfang definieren
GREEN='\033[0;32m'
NC='\033[0m'

# Setze Zielverzeichnis relativ zu diesem Script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUT_DIR="$SCRIPT_DIR/dependencies"

rm -rf "$OUT_DIR"
mkdir -p "$OUT_DIR"

echo "📦 Exportiere installierte Pakete nach: $OUT_DIR"

echo -e "${GREEN}==> Systemupdate und Basis-Tools installieren...${NC}"
sudo pacman -Syu --noconfirm
sudo pacman -S --needed --noconfirm base-devel git wget curl zsh flatpak neovim lua51 luarocks go nodejs npm openssh

echo -e "${GREEN}==> Installiere Hyprland-Umgebung...${NC}"
sudo pacman -S --needed --noconfirm hyprland waybar dunst xdg-desktop-portal-hyprland sddm

# Rust installieren, wenn nicht vorhanden
if ! command -v rustc &> /dev/null; then
    echo -e "${GREEN}==> Installiere Rust...${NC}"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi
rustup update
rustup component add rust-analyzer

# Paru installieren, falls nötig
if ! command -v paru &> /dev/null; then
    echo -e "${GREEN}==> Installiere paru (AUR)...${NC}"
    cd /tmp
    git clone https://aur.archlinux.org/paru.git
    cd paru
    makepkg -si --noconfirm
fi

# Versionen checken
rustc --version
cargo --version
rustup --version

# Exportiere installierte Pakete
pacman -Qqe > "$OUT_DIR/pacman.txt"
paru -Qqe > "$OUT_DIR/paru.txt" || echo "⚠️ paru nicht gefunden"
flatpak list --app --columns=application > "$OUT_DIR/flatpak.txt" || echo "⚠️ flatpak nicht gefunden"

echo "✅ Paketlisten sind in $OUT_DIR"

# Flatpak einrichten
echo -e "${GREEN}==> Flatpak & Snapd einrichten...${NC}"
sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

# Netzwerkdienste & Loginmanager
sudo systemctl enable --now NetworkManager sddm

# Dotfiles-abhängige Pakete installieren
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
DEPENDENCY_DIR="$DOTFILES_DIR/dependencies"

echo -e "${GREEN}==> Installiere Pakete aus dependencies/...${NC}"
[[ -f "$DEPENDENCY_DIR/pacman.txt" ]] && sudo pacman -S --needed --noconfirm $(< "$DEPENDENCY_DIR/pacman.txt")
[[ -f "$DEPENDENCY_DIR/paru.txt" && -x "$(command -v paru)" ]] && paru -S --needed --noconfirm $(< "$DEPENDENCY_DIR/paru.txt")
if [[ -f "$DEPENDENCY_DIR/flatpak.txt" ]]; then
    while IFS= read -r pkg; do
        flatpak install -y flathub "$pkg"
    done < "$DEPENDENCY_DIR/flatpak.txt"
fi

# Dev-Tools
echo -e "${GREEN}==> Entwicklertools installieren...${NC}"
sudo luarocks install luacheck
sudo pacman -S --noconfirm tmux

paru -S --noconfirm --needed opencode-bin ttf-font-awesome waybar ttf-jetbrains-mono-nerd ttf-nerd-fonts-symbols ffmpeg aalib ascii-image-converter-bin

# fzf Installation via HTTPS (kein SSH-Key nötig)
if [[ ! -d "$HOME/fzf" ]]; then
    git clone https://github.com/junegunn/fzf.git "$HOME/fzf"
    "$HOME/fzf/install" --all
fi

# Rust Tools
cargo install stylua --features luajit

# Go Tools
go install golang.org/x/tools/cmd/goimports@latest
go install github.com/go-delve/delve/cmd/dlv@latest
go install honnef.co/go/tools/cmd/staticcheck@latest
go install golang.org/x/tools/gopls@latest
go install github.com/air-verse/air@latest

# Node.js Tools
sudo npm install -g typescript typescript-language-server eslint prettier

# Programmieren-Verzeichnis
mkdir -p "$HOME/programmieren"

# Aufräumen & Updates
paru -Qdtq | xargs -r sudo pacman -Rns
sudo pacman -Syu --noconfirm

# Standard-Bildbetrachter
xdg-mime default org.gnome.Loupe.desktop image/png
xdg-mime default org.gnome.Loupe.desktop image/jpeg
xdg-mime default org.gnome.Loupe.desktop image/jpg
xdg-mime default org.gnome.Loupe.desktop image/gif
xdg-mime default org.gnome.Loupe.desktop image/webp

# Dienste
sudo systemctl enable --now sshd

# Oh My Zsh (einmalig, ohne interaktive Shell-Änderung)
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo -e "${GREEN}==> Installiere Oh My Zsh...${NC}"
    RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    chsh -s "$(which zsh)"
fi

echo -e "${GREEN}✅ Setup abgeschlossen! Starte den PC ggf. neu.${NC}"

